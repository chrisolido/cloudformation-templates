{
    "Parameters": {
        "EnvironmentSize": {
            "Type": "String",
            "Default": "SMALL",
            "AllowedValues": [
                "SMALL",
                "MEDIUM",
                "LARGE"
            ],
            "Description": "Select Environment Size (S,M,L)"
        },
        "DatabaseName": {
            "Type": "String",
            "Default": "wordpress"
        },
        "DatabaseUser": {
            "Type": "String",
            "Default": "admin"
        },
        "DatabasePassword": {
            "Type": "String",
            "Default": "wordpress",
            "NoEcho": true
        }
    },
    "Mappings": {
        "RegionMap": {
            "us-east-1": {
                "AMALINUX": "ami-013be31976ca2c322"
            },
            "us-east-2": {
                "AMALINUX": "ami-0b59bfac6be064b78"
            },
            "us-west-1": {
                "AMALINUX": "ami-01beb64058d271bc4"
            },
            "us-west-2": {
                "AMALINUX": "ami-061e7ebbc234015fe"
            },
            "ca-central-1": {
                "AMALINUX": "ami-076b4adb3f90cd384"
            },
            "eu-central-1": {
                "AMALINUX": "ami-02ea8f348fa28c108"
            },
            "eu-west-1": {
                "AMALINUX": "ami-0a5e707736615003c"
            },
            "eu-west-2": {
                "AMALINUX": "ami-0274e11dced17bb5b"
            },
            "eu-west-3": {
                "AMALINUX": "ami-051707cdba246187b"
            },
            "ap-northeast-1": {
                "AMALINUX": "ami-0a2de1c3b415889d2"
            },
            "ap-northeast-2": {
                "AMALINUX": "ami-0b4fdb56a00adb616"
            },
            "ap-south-1": {
                "AMALINUX": "ami-06bcd1131b2f55803"
            },
            "ap-southeast-1": {
                "AMALINUX": "ami-085fd1bd447be68e8"
            },
            "ap-southeast-2": {
                "AMALINUX": "ami-0b8dea0e70b969adc"
            },
            "sa-east-1": {
                "AMALINUX": "ami-0112d42866980b373"
            }
        },
        "InstanceSize": {
            "SMALL": {
                "EC2": "t2.micro",
                "DB": "db.t2.micro"
            },
            "MEDIUM": {
                "EC2": "t2.small",
                "DB": "db.t2.small"
            },
            "LARGE": {
                "EC2": "t2.medium",
                "DB": "db.t2.medium"
            }
        }
    },
    "Resources": {
        "DBInstance": {
            "Type": "AWS::RDS::DBInstance",
            "Properties": {
                "AllocatedStorage": "5",
                "StorageType": "gp2",
                "DBInstanceClass": {
                    "Fn::FindInMap": [
                        "InstanceSize",
                        {
                            "Ref": "EnvironmentSize"
                        },
                        "DB"
                    ]
                },
                "DBSecurityGroups": [
                    {
                        "Ref": "DBSecurityGroup"
                    }
                ],
                "DBName": {
                    "Ref": "DatabaseName"
                },
                "Engine": "MariaDB",
                "MasterUsername": {
                    "Ref": "DatabaseUser"
                },
                "MasterUserPassword": {
                    "Ref": "DatabasePassword"
                }
            }
        },
        "DBSecurityGroup": {
            "Type": "AWS::RDS::DBSecurityGroup",
            "Properties": {
                "GroupDescription": "Database Security Group",
                "DBSecurityGroupIngress": [
                    {
                        "EC2SecurityGroupName": {
                            "Ref": "EC2SecurityGroup"
                        }
                    }
                ]
            }
        },
        "EC2Instance": {
            "Type": "AWS::EC2::Instance",
            "Properties": {
                "ImageId": {
                    "Fn::FindInMap": [
                        "RegionMap",
                        {
                            "Ref": "AWS::Region"
                        },
                        "AMALINUX"
                    ]
                },
                "InstanceType": {
                    "Fn::FindInMap": [
                        "InstanceSize",
                        {
                            "Ref": "EnvironmentSize"
                        },
                        "EC2"
                    ]
                },
                "KeyName": "AdvancedCFN",
                "SecurityGroupIds": [
                    {
                        "Ref": "EC2SecurityGroup"
                    }
                ],
                "UserData": {
                    "Fn::Base64": {
                        "Fn::Sub": "#!/bin/bash\nyum update -y aws-cfn-bootstrap\n/opt/aws/bin/cfn-init -v --stack ${AWS::StackName} --resource EC2Instance --configsets wordpress --region ${AWS::Region}\nyum -y update\n"
                    }
                }
            },
            "Metadata": {
                "AWS::CloudFormation::Init": {
                    "configSets": {
                        "wordpress": [
                            "configure_cfn",
                            "install_wordpress",
                            "config_wordpress"
                        ]
                    },
                    "configure_cfn": {
                        "files": {
                            "/etc/cfn/hooks.d/cfn-auto-reloader.conf": {
                                "content": {
                                    "Fn::Sub": "[cfn-auto-reloader-hook]\ntriggers=post.update\npath=Resources.EC2Instance.Metadata.AWS::CloudFormation::Init\naction=/opt/aws/bin/cfn-init -v --stack ${AWS::StackName} --resource EC2Instance --configsets wordpress --region ${AWS::Region}\n"
                                },
                                "mode": "000400",
                                "owner": "root",
                                "group": "root"
                            },
                            "/etc/cfn/cfn-hup.conf": {
                                "content": {
                                    "Fn::Sub": "[main]\nstack=${AWS::StackId}\nregion=${AWS::Region}\nverbose=true\ninterval=5\n"
                                },
                                "mode": "000400",
                                "owner": "root",
                                "group": "root"
                            }
                        },
                        "services": {
                            "sysvinit": {
                                "cfn-hup": {
                                    "enabled": "true",
                                    "ensureRunning": "true",
                                    "files": [
                                        "/etc/cfn/cfn-hup.conf",
                                        "/etc/cfn/hooks.d/cfn-auto-reloader.conf"
                                    ]
                                }
                            }
                        }
                    },
                    "install_wordpress": {
                        "packages": {
                            "yum": {
                                "httpd": [],
                                "php": [],
                                "php-mysqlnd": [],
                                "mariadb": []
                            }
                        },
                        "sources": {
                            "/var/www/html": "http://wordpress.org/latest.tar.gz"
                        },
                        "services": {
                            "sysvinit": {
                                "httpd": {
                                    "enabled": "true",
                                    "ensureRunning": "true",
                                    "files": [
                                        "/etc/httpd/conf/httpd.conf"
                                    ]
                                }
                            }
                        }
                    },
                    "config_wordpress": {
                        "commands": {
                            "01_copy_to_root": {
                                "cwd": "/var/www/html",
                                "test": "test ! -e /var/www/html/wp-config.php",
                                "command": "cp -r wordpress/* /var/www/html"
                            },
                            "02_clean_up": {
                                "cwd": "/var/www/html",
                                "command": "rm -rf wordpress"
                            },
                            "03_clone_config": {
                                "cwd": "/var/www/html",
                                "test": "test ! -e /var/www/html/wp-config.php",
                                "command": "cp wp-config-sample.php wp-config.php"
                            },
                            "04_inject_dbhost": {
                                "cwd": "/var/www/html",
                                "command": {
                                    "Fn::Sub": "sed -i 's/localhost/${DBInstance.Endpoint.Address}/g' wp-config.php\n"
                                }
                            },
                            "05_inject_dbname": {
                                "cwd": "/var/www/html",
                                "command": {
                                    "Fn::Sub": "sed -i 's/database_name_here/${DatabaseName}/g' wp-config.php\n"
                                }
                            },
                            "06_nject_dbuser": {
                                "cwd": "/var/www/html",
                                "command": {
                                    "Fn::Sub": "sed -i 's/username_here/${DatabaseUser}/g' wp-config.php\n"
                                }
                            },
                            "07_inject_dbpassword": {
                                "cwd": "/var/www/html",
                                "command": {
                                    "Fn::Sub": "sed -i 's/password_here/${DatabasePassword}/g' wp-config.php\n"
                                }
                            }
                        }
                    }
                }
            }
        },
        "EC2SecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupDescription": "Open Ports 22 and 80",
                "SecurityGroupIngress": [
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 22,
                        "ToPort": 22,
                        "CidrIp": "0.0.0.0/0"
                    },
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 80,
                        "ToPort": 80,
                        "CidrIp": "0.0.0.0/0"
                    }
                ]
            }
        },
        "S3Bucket": {
            "Type": "AWS::S3::Bucket"
        }
    },
    "Outputs": {
        "Website": {
            "Description": "The Public DNS for the EC2 Instance",
            "Value": {
                "Fn::Sub": "http://${EC2Instance.PublicDnsName}"
            }
        }
    }
}